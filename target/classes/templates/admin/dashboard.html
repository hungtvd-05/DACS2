<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Modernize Free</title>
    <link rel="shortcut icon" type="image/png" href="img/logos/favicon.png" />
    <link rel="stylesheet" th:href="@{/css/styles.min.css}"/>
</head>

<body>
<div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
     data-sidebar-position="fixed" data-header-position="fixed">
    <aside class="left-sidebar">
        <div>
            <div class="brand-logo d-flex align-items-center justify-content-between">
                <a href="./index.html" class="text-nowrap logo-img">
                    <img src="img/logos/dark-logo.svg" width="180" alt="" />
                </a>
                <div class="close-btn d-xl-none d-block sidebartoggler cursor-pointer" id="sidebarCollapse">
                    <i class="ti ti-x fs-8"></i>
                </div>
            </div>
            <nav class="sidebar-nav scroll-sidebar" data-simplebar="">
                <ul id="sidebarnav">
                    <li class="nav-small-cap">
                        <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
                        <span class="hide-menu">Home</span>
                    </li>
                    <li class="sidebar-item">
                        <a class="sidebar-link" href="/admin" aria-expanded="false">
                            <span>
                              <i class="ti ti-layout-dashboard"></i>
                            </span>
                            <span class="hide-menu">Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-small-cap">
                        <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
                        <span class="hide-menu">UI COMPONENTS</span>
                    </li>
                    <li class="sidebar-item">
                        <a class="sidebar-link" href="./ui-buttons.html" aria-expanded="false">
                <span>
                  <i class="ti ti-article"></i>
                </span>
                            <span class="hide-menu">Buttons</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a class="sidebar-link" href="./ui-alerts.html" aria-expanded="false">
                <span>
                  <i class="ti ti-alert-circle"></i>
                </span>
                            <span class="hide-menu">Alerts</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a class="sidebar-link" href="./ui-card.html" aria-expanded="false">
                <span>
                  <i class="ti ti-cards"></i>
                </span>
                            <span class="hide-menu">Card</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a class="sidebar-link" href="./ui-forms.html" aria-expanded="false">
                <span>
                  <i class="ti ti-file-description"></i>
                </span>
                            <span class="hide-menu">Forms</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a class="sidebar-link" href="./ui-typography.html" aria-expanded="false">
                <span>
                  <i class="ti ti-typography"></i>
                </span>
                            <span class="hide-menu">Typography</span>
                        </a>
                    </li>
                    <li class="nav-small-cap">
                        <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
                        <span class="hide-menu">AUTH</span>
                    </li>
                    <li class="sidebar-item">
                        <a class="sidebar-link" href="./authentication-login.html" aria-expanded="false">
                <span>
                  <i class="ti ti-login"></i>
                </span>
                            <span class="hide-menu">Login</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a class="sidebar-link" href="./authentication-register.html" aria-expanded="false">
                <span>
                  <i class="ti ti-user-plus"></i>
                </span>
                            <span class="hide-menu">Register</span>
                        </a>
                    </li>
                    <li class="nav-small-cap">
                        <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
                        <span class="hide-menu">EXTRA</span>
                    </li>
                    <li class="sidebar-item">
                        <a class="sidebar-link" href="./icon-tabler.html" aria-expanded="false">
                <span>
                  <i class="ti ti-mood-happy"></i>
                </span>
                            <span class="hide-menu">Icons</span>
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a class="sidebar-link" href="./sample-page.html" aria-expanded="false">
                <span>
                  <i class="ti ti-aperture"></i>
                </span>
                            <span class="hide-menu">Sample Page</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <!-- End Sidebar navigation -->
        </div>
        <!-- End Sidebar scroll-->
    </aside>
    <!--  Sidebar End -->
    <!--  Main wrapper -->
    <div class="body-wrapper">
        <!--  Header Start -->
        <header class="app-header">
            <nav class="navbar navbar-expand-lg navbar-light">
                <ul class="navbar-nav">
                    <li class="nav-item d-block d-xl-none">
                        <a class="nav-link sidebartoggler nav-icon-hover" id="headerCollapse" href="javascript:void(0)">
                            <i class="ti ti-menu-2"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-icon-hover" href="javascript:void(0)">
                            <i class="ti ti-bell-ringing"></i>
                            <div class="notification bg-primary rounded-circle"></div>
                        </a>
                    </li>
                </ul>
                <div class="navbar-collapse justify-content-end px-0" id="navbarNav">
                    <ul class="navbar-nav flex-row ms-auto align-items-center justify-content-end">
                        <a href="https://adminmart.com/product/modernize-free-bootstrap-admin-dashboard/" target="_blank" class="btn btn-primary">Download Free</a>
                        <li class="nav-item dropdown">
                            <a class="nav-link nav-icon-hover" href="javascript:void(0)" id="drop2" data-bs-toggle="dropdown"
                               aria-expanded="false">
                                <img src="img/profile/user-1.jpg" alt="" width="35" height="35" class="rounded-circle">
                            </a>
                            <div class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up" aria-labelledby="drop2">
                                <div class="message-body">
                                    <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                                        <i class="ti ti-user fs-6"></i>
                                        <p class="mb-0 fs-3">My Profile</p>
                                    </a>
                                    <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                                        <i class="ti ti-mail fs-6"></i>
                                        <p class="mb-0 fs-3">My Account</p>
                                    </a>
                                    <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                                        <i class="ti ti-list-check fs-6"></i>
                                        <p class="mb-0 fs-3">My Task</p>
                                    </a>
                                    <a href="./authentication-login.html" class="btn btn-outline-primary mx-3 mt-2 d-block">Logout</a>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </nav>
        </header>
        <!--  Header End -->
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-4">
                    <!-- Monthly Earnings -->
                    <div class="card">
                        <div class="card-body">
                            <div class="row alig n-items-start">
                                <div class="col-8">
                                    <h5 class="card-title mb-9 fw-semibold"> Doanh thu tháng này </h5>
                                    <h4 class="fw-semibold mb-3" id="totalSalesComplete"></h4>
                                    <div class="d-flex align-items-center pb-1">
                                        <p class="fs-3 mb-0" id="totalSales"></p>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="d-flex justify-content-end">
                                        <div
                                                class="text-white bg-secondary rounded-circle p-6 d-flex align-items-center justify-content-center">
                                            <i class="ti ti-currency-dollar fs-6"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <!-- Monthly Earnings -->
                    <div class="card">
                        <div class="card-body">
                            <div class="row alig n-items-start">
                                <div class="col-8">
                                    <h5 class="card-title mb-9 fw-semibold"> Doanh thu tháng trước </h5>
                                    <h4 class="fw-semibold mb-3" id="totalSalesCompleteLastMonth"></h4>
                                    <div class="d-flex align-items-center pb-1">
                                        <p class="fs-3 mb-0" id="totalSalesLastMonth"></p>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="d-flex justify-content-end">
                                        <div
                                                class="text-white bg-secondary rounded-circle p-6 d-flex align-items-center justify-content-center">
                                            <i class="ti ti-currency-dollar fs-6"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <!-- Yearly Breakup -->
                    <div class="card overflow-hidden">
                        <div class="card-body p-4">
                            <div class="row align-items-center">
                                <div class="col-4">
                                    <div class="d-flex justify-content-center">
                                        <div id="orderChart"></div>
                                    </div>
                                </div>
                                <div class="col-8">
                                    <h5 class="card-title mb-9 fw-semibold">Đơn hàng tháng này</h5>
                                    <h4 class="fw-semibold mb-3" id="orderComplete"></h4>
                                    <div class="d-flex align-items-center mb-3">
                                        <p class="fs-3 mb-0" id="countOrdersByMonth"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card w-100">
                <div class="card-body">
                    <div class="d-sm-flex d-block align-items-center justify-content-between mb-9">
                        <div class="mb-3 mb-sm-0">
                            <h5 class="card-title fw-semibold">Doanh thu</h5>
                        </div>
                        <div>
                            <select class="form-select" id="salesType">
                                <option value="last7days">7 ngày gần nhất</option>
                                <option value="month">Tháng này</option>
                                <option value="lastmonth">Tháng trước</option>
                            </select>
                        </div>
                    </div>
                    <div id="doanhthu"></div>
                </div>
            </div>
            <div class="card w-100">
                <div class="card-body">
                    <div class="d-sm-flex d-block align-items-center justify-content-between mb-9">
                        <div class="mb-3 mb-sm-0">
                            <h5 class="card-title fw-semibold">Số lượng đơn hàng</h5>
                        </div>
                        <div>
                            <select class="form-select" id="ordersType">
                                <option value="last7days">7 ngày gần nhất</option>
                                <option value="month">Tháng này</option>
                                <option value="lastmonth">Tháng trước</option>
                            </select>
                        </div>
                    </div>
                    <div id="ordersChart"></div>
                </div>
            </div>
            <div class="card w-100">
                <div class="card-body">
                    <div class="d-sm-flex d-block align-items-center justify-content-between mb-9">
                        <div class="mb-3 mb-sm-0">
                            <h5 class="card-title fw-semibold">Doanh thu sản phẩm</h5>
                        </div>
                    </div>
                    <div id="productsChart"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<script th:src="@{/libs/jquery/dist/jquery.min.js}"></script>
<script th:src="@{/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/js/sidebarmenu.js}"></script>
<script th:src="@{/js/app.min.js}"></script>
<script th:src="@{/libs/apexcharts/dist/apexcharts.min.js}"></script>
<script th:src="@{/libs/simplebar/dist/simplebar.js}"></script>

<script>

    $(document).ready(function() {
        var chart = {
            series: [
                {
                    name: "Doanh thu dự kiến",
                    data: [],
                    type: 'line'
                },
                {
                    name: "Doanh thu đạt được",
                    data: [],
                    type: 'line'
                },
            ],

            chart: {
                // height: 345,
                type: 'line',
                zoom: {
                    enabled: false
                },
                toolbar: { show: true },
                foreColor: "#adb0bb",
                fontFamily: 'inherit',
            },

            colors: ["#5D87FF", "#49BEFF"],

            dataLabels: {
                enabled: false
            },

            stroke: {
                width: [3, 3],
                curve: 'smooth',
                dashArray: [0, 0]
            },

            legend: {
                show: true,
                position: 'top',
                horizontalAlign: 'right',
                floating: true,
                offsetY: -25,
                offsetX: -5
            },

            markers: {
                size: 4,
                hover: {
                    size: 6
                }
            },

            grid: {
                borderColor: "rgba(0,0,0,0.1)",
                strokeDashArray: 3,
                xaxis: {
                    lines: {
                        show: false
                    }
                },
                padding: {
                    top: 10
                }
            },

            xaxis: {
                type: "category",
                categories: [],
                labels: {
                    style: {
                        cssClass: "grey--text lighten-2--text fill-color",
                        colors: '#adb0bb'
                    },
                },
            },

            yaxis: {
                show: true,
                min: 0,
                // max: 0,
                tickAmount: 4,
                labels: {
                    style: {
                        cssClass: "grey--text lighten-2--text fill-color",
                        colors: '#adb0bb'
                    },
                }
            },

            tooltip: {
                theme: 'light',
                shared: true,
                intersect: false,
                y: {
                    formatter: function (y) {
                        if (typeof y !== "undefined") {
                            return y.toFixed(0) + " &#8363";
                        }
                        return y;
                    }
                }
            },

            responsive: [
                {
                    breakpoint: 600,
                    options: {
                        legend: {
                            show: false
                        },
                    }
                }
            ]
        };

        var chartInstance = new ApexCharts(document.querySelector("#doanhthu"), chart);
        chartInstance.render();


        function loadRevenueData(type) {
            $("#doanhthu").addClass("loading");

            $.ajax({
                url: '/api/getSales',
                method: 'GET',
                data: { type: type },
                success: function(response) {
                    if (response && response.sales && response.dates && response.salesComplete) {
                        var nmax = Math.max(...response.sales);
                        chartInstance.updateOptions({
                            xaxis: {
                                categories: response.dates
                            },
                            yaxis: {
                                // tickAmount: 6,
                                max: (Math.ceil(nmax / 100000) * 100000)
                            }
                        });

                        chartInstance.updateSeries([
                            {
                                name: "Doanh thu dự kiến",
                                data: response.sales,
                                type: 'line'
                            },
                            {
                                name: "Doanh thu đạt được",
                                data: response.salesComplete,
                                type: 'line'
                            },

                        ]);
                    }

                },
                error: function(xhr, status, error) {
                    console.error('Error loading revenue data:', error);
                    $("#error-message").show().text('Không thể tải dữ liệu. Vui lòng thử lại sau.');
                },
                complete: function() {
                    $("#doanhthu").removeClass("loading");
                }
            });
        }

        loadRevenueData("last7days");

        $('#salesType').change(function() {
            console.log($(this).val())
            loadRevenueData($(this).val());
        });

        var ordersChart = {
            series: [
                { name: "Tổng đơn hàng", data: [] },
                { name: "Đơn hàng đã giao", data: [] },
            ],

            chart: {
                type: "bar",
                // height: 345,
                offsetX: -15,
                toolbar: { show: true },
                foreColor: "#adb0bb",
                fontFamily: 'inherit',
                sparkline: { enabled: false },
            },


            colors: ["#5D87FF", "#49BEFF"],


            plotOptions: {
                bar: {
                    horizontal: false,
                    columnWidth: "35%",
                    borderRadius: [6],
                    borderRadiusApplication: 'end',
                    borderRadiusWhenStacked: 'all'
                },
            },
            markers: { size: 0 },

            dataLabels: {
                enabled: false,
            },


            legend: {
                show: false,
            },


            grid: {
                borderColor: "rgba(0,0,0,0.1)",
                strokeDashArray: 3,
                xaxis: {
                    lines: {
                        show: false,
                    },
                }
            },

            xaxis: {
                type: "category",
                categories: [],
                labels: {
                    style: { cssClass: "grey--text lighten-2--text fill-color" },
                },
            },


            yaxis: {

                show: true,
                min: 0,
                tickAmount: 3,
                // max: 7,
                labels: {
                    style: {
                        cssClass: "grey--text lighten-2--text fill-color",
                    },
                },
            },
            stroke: {
                show: true,
                width: 3,
                lineCap: "butt",
                colors: ["transparent"],
            },


            // tooltip: { theme: "light" },

            tooltip: {
                theme: 'light',
                shared: true,
                intersect: false,
                y: {
                    formatter: function (y) {
                        if (typeof y !== "undefined") {
                            return y.toFixed(0) + " đơn hàng";
                        }
                        return y;
                    }
                }
            },

            responsive: [
                {
                    breakpoint: 600,
                    options: {
                        plotOptions: {
                            bar: {
                                borderRadius: 3,
                            }
                        },
                    }
                }
            ]


        };

        var ordersChartRender = new ApexCharts(document.querySelector("#ordersChart"), ordersChart);
        ordersChartRender.render();

        function loadOrdersData(type) {
            $("#ordersChart").addClass("loading");

            $.ajax({
                url: '/api/getOrders',
                method: 'GET',
                data: { type: type },
                success: function(response) {
                    if (response && response.orders && response.dates && response.ordersComplete) {
                        ordersChartRender.updateOptions({
                            xaxis: {
                                categories: response.dates
                            },
                            yaxis: {
                                min: 0,
                                // max: maxValue,
                                // tickAmount: 3,
                                // forceNiceScale: true,
                                // decimalsInFloat: 0,
                                labels: {
                                    formatter: function(val) {
                                        return Math.floor(val);
                                    }
                                }
                                // max: (Math.max(...response.orders))
                            }
                        });

                        ordersChartRender.updateSeries([
                            {
                                name: "Tổng đơn hàng",
                                data: response.orders
                            },
                            {
                                name: "Đơn hàng đã giao",
                                data: response.ordersComplete
                            },

                        ]);
                    }

                },
                error: function(xhr, status, error) {
                    console.error('Error loading revenue data:', error);
                    $("#error-message").show().text('Không thể tải dữ liệu. Vui lòng thử lại sau.');
                },
                complete: function() {
                    $("#doanhthu").removeClass("loading");
                }
            });
        }

        loadOrdersData("last7days");

        $('#ordersType').change(function() {
            loadOrdersData($(this).val());
        });

        var totalSalesComplete = document.getElementById("totalSalesComplete");
        var totalSales= document.getElementById("totalSales");
        var totalSalesCompleteLastMonth = document.getElementById("totalSalesCompleteLastMonth");
        var totalSalesLastMonth= document.getElementById("totalSalesLastMonth");

        var breakup = {
            series: [],
            labels: [],
            chart: {
                width: 160,
                type: "donut",
                fontFamily: "Plus Jakarta Sans', sans-serif",
                foreColor: "#adb0bb",
            },
            plotOptions: {
                pie: {
                    startAngle: 0,
                    endAngle: 360,
                    // donut: {
                    //     size: '75%',
                    // },
                },
            },
            stroke: {
                show: false,
            },

            dataLabels: {
                enabled: false,
            },

            legend: {
                show: false,
            },

            responsive: [
                {
                    breakpoint: 991,
                    options: {
                        chart: {
                            width: 150,
                        },
                    },
                },
            ],
            tooltip: {
                theme: "dark",
                fillSeriesColor: false,
            },
        };

        var orderChartRender = new ApexCharts(document.querySelector("#orderChart"), breakup);
        orderChartRender.render();

        function loadOrderData() {
            $("#orderChart").addClass("loading");

            $.ajax({
                url: '/api/getOrder',
                method: 'GET',
                success: function(response) {
                    if (response && response.countOrders && response.ordersStatus && response.totalSalesComplete && response.totalSales &&
                        response.totalSalesCompleteLastMonth && response.totalSalesLastMonth) {
                        orderComplete.innerHTML = response.ordersComplete + " đơn hoàn thành";
                        countOrdersByMonth.innerHTML = "Tổng: " + response.countOrdersByMonth + " đơn";
                        totalSalesComplete.innerHTML = response.totalSalesComplete;
                        totalSales.innerHTML = "Doanh thu dự kiến: " + response.totalSales;
                        totalSalesCompleteLastMonth.innerHTML = response.totalSalesCompleteLastMonth;
                        totalSalesLastMonth.innerHTML = "Doanh thu dự kiến: " + response.totalSalesLastMonth;
                        orderChartRender.updateOptions({
                            labels: response.ordersStatus
                        });

                        orderChartRender.updateSeries(response.countOrders);
                    }

                },
                error: function(xhr, status, error) {
                    console.error('Error loading revenue data:', error);
                    $("#error-message").show().text('Không thể tải dữ liệu. Vui lòng thử lại sau.');
                },
                complete: function() {
                    $("#orderChart").removeClass("loading");
                }
            });
        }

        loadOrderData();

        var productsChart = {
            series: [
                { name: "Doanh thu", data: [] }
            ],

            chart: {
                type: "bar",
                height: 345,
                offsetX: -15,
                toolbar: { show: true },
                foreColor: "#adb0bb",
                fontFamily: 'inherit',
                sparkline: { enabled: false },
            },


            colors: ["#5D87FF", "#49BEFF"],


            plotOptions: {
                bar: {
                    horizontal: true,
                    // columnWidth: "35%",
                    // borderRadius: [6],
                    borderRadius: 4,
                    borderRadiusApplication: 'end',
                    // borderRadiusWhenStacked: 'all'
                },
            },
            markers: { size: 0 },

            dataLabels: {
                enabled: false,
            },


            legend: {
                show: false,
            },


            grid: {
                borderColor: "rgba(0,0,0,0.1)",
                strokeDashArray: 3,
                yaxis: {
                    lines: {
                        show: false,
                    },
                }
            },
            xaxis: {
                type: "category",
                categories: [],
                labels: {
                    style: { cssClass: "grey--text lighten-2--text fill-color" },
                },
            },
            yaxis: {
                show: true,
                min: 0,
                tickAmount: 4,
                // max: 7,
                labels: {
                    style: {
                        cssClass: "grey--text lighten-2--text fill-color",
                    },
                },
            },



            stroke: {
                show: true,
                width: 3,
                lineCap: "butt",
                colors: ["transparent"],
            },


            tooltip: { theme: "light" },

            tooltip: {
                theme: 'light',
                // x: {
                //     title: {
                //         formatter: function() {
                //             return 'Doanh thu:';
                //         }
                //     }
                // },
                y: {
                    formatter: function(val) {
                        return new Intl.NumberFormat('vi-VN', {
                            style: 'currency',
                            currency: 'VND'
                        }).format(val);
                    }
                }
            },

            responsive: [
                {
                    breakpoint: 600,
                    options: {
                        plotOptions: {
                            bar: {
                                borderRadius: 3,
                            }
                        },
                    }
                }
            ]


        };
        var productsChartRender = new ApexCharts(document.querySelector("#productsChart"), productsChart);
        productsChartRender.render();

        function loadProductsData() {
            $("#productsChart").addClass("loading");

            $.ajax({
                url: '/api/getProducts',
                method: 'GET',
                success: function(response) {
                    if (response && response.productNames && response.sumProducts) {
                        console.log(response.productNames)
                        productsChartRender.updateOptions({

                            xaxis: {
                                categories: response.productNames
                            },
                            // xaxis: {
                            //     min: 0,
                            //     labels: {
                            //         formatter: function(val) {
                            //             return Math.floor(val);
                            //         }
                            //     }
                            // }
                        });

                        productsChartRender.updateSeries([
                            {
                                name: "Doanh thu",
                                data: response.sumProducts
                            },
                        ]);
                    }

                },
                error: function(xhr, status, error) {
                    console.error('Error loading revenue data:', error);
                    $("#error-message").show().text('Không thể tải dữ liệu. Vui lòng thử lại sau.');
                },
                complete: function() {
                    $("#productsChart").removeClass("loading");
                }
            });
        }

        loadProductsData();
    });
</script>

</body>

</html>